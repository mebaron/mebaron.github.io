---
title: go访问数据库
type: tags
date: 2023-12-27 15:04:26
tags:
- go
- mysql
categories:
- 学习笔记
---

## go访问数据库

提前准备的数据表结构：

```sql
CREATE TABLE `userinfo` (
	`uid` INT(10) NOT NULL AUTO_INCREMENT,
	`username` VARCHAR ( 64 ) NULL DEFAULT NULL,
	`departname` VARCHAR ( 64 ) NULL DEFAULT NULL,
	`created` DATE NULL DEFAULT NULL,
PRIMARY KEY ( `uid` ) 
)


CREATE TABLE `userdetail` (
	`uid` INT ( 10 ) NOT NULL DEFAULT 0,
	`intro` TEXT NULL,
	`profile` TEXT NULL,
PRIMARY KEY ( `uid` ) 
)
```

### 1.go操作MySQL数据库

案例使用的是github.com/go-sql-driver/mysql的MySQL驱动，该驱动完全支持database/sql接口，支持keepalive。

```go
package main

import (
	"database/sql"
	"fmt"
	"log"
	"time"

	// 注册driver
	_ "github.com/go-sql-driver/mysql"
)

func main() {
	// 连接数据库
	db, _ := sql.Open("mysql", "root:123456@tcp(127.0.0.1:3306)/test?charset=utf8")

	// 增
	stmt, _ := db.Prepare("INSERT userinfo SET username=?,departname=?,created=?")
	res, _ := stmt.Exec("mebaron", "研发部门", time.Now())

	id, _ := res.LastInsertId()
	fmt.Printf("id: %v\n", id)

	// 删
	stmt, _ = db.Prepare("delete from userinfo where uid=?")
	res, _ = stmt.Exec(id - 3)
	effect, _ := res.RowsAffected()
	fmt.Printf("delete effect: %v\n", effect)

	// 改
	stmt, _ = db.Prepare("update userinfo set username=? where uid=?")
	res, _ = stmt.Exec("baron", id)

	effect, _ = res.RowsAffected()
	fmt.Printf("update effect: %v\n", effect)

	// 查
	rows, _ := db.Query("select * from userinfo")

	for rows.Next() {
		var (
			uid        int
			username   string
			departname string
			created    string
		)
		rows.Scan(&uid, &username, &departname, &created)
		fmt.Println(uid, username, departname, created)
	}

	// 事务
	tx, _ := db.Begin()
	stmt, _ = tx.Prepare("INSERT userinfo SET username=?,departname=?,created=?")
	res, _ = stmt.Exec("tx", "测试部门", time.Now())
	id, _ = res.LastInsertId()
	fmt.Printf("id: %v\n", id)
	res, _ = tx.Stmt(stmt).Exec("tx-baron", "测试1部门", time.Now())
	id, _ = res.LastInsertId()
	fmt.Printf("id: %v\n", id)

	stmt, _ = tx.Prepare("INSERT userdetail SET uid=?,intro=?,profile=?")
	stmt.Exec(id, "intro text", "profile text")

    // 事务必须以对Commit或Rollback的调用结束。调用Commit或Rollback后，一旦出现某部分失败，所有对事务的操作都会失败并返回错误值ErrTxDone
	tx.Commit()
	// tx.Rollback()
}
```

